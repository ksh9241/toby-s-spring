# 1장. IoC 컨테이너와 DI

### IoC 컨테이너 : 빈 팩토리와 애플리케이션 컨텍스트
스프링에선 IoC를 담당하는 컨테이너를 빈 팩토리 또는 애플리케이션 컨텍스트라고 부르기도 한다. 오브젝트 생성과 오브젝트 사이의 런타임 관계를 설정하는 DI 관점으로 볼 떄는 컨테이너를 빈 팩토리라고 한다.

#### 1.1.1 IoC 컨테이너를 이용해 애플리케이션 만들기

##### POJO 클래스
각각의 POJO는 특정 기술과 스펙에서 독립적일뿐더러 의존관계에 있는 다른 POJO와 느슨한 결합을 갖도록 만들어야 한다.

##### 설정 메타정보
스프링의 설정 메타정보는 BeanDefinition 인터페이스로 표현되는 순수한 추상 정보다. 즉 애플리케이션 컨텍스트는 바로 이 BeanDefinition으로 만들어진 메타정보를 담은 오브젝트를 사용해 IoC와 DI 작업을 수행한다.
원본의 포맷과 구조, 자료의 특성에 맞게 읽어와 BeanDefinition 오브젝트로 변환해주는 BeanDefinitionReader가 있으면 된다.

- 빈 메타정보
	- 빈 아이디, 이름, 별칭 : 빈 오브젝트를 구분할 수 있는 식별자
	- 클래스 또는 클래스 이름 : 빈으로 만들 POJO 클래스 또는 서비스 클래스 정보
	- 스코프 : 싱글톤, 프로토타입과 같은 빈의 생성 방식과 존재 범위
	- 프로퍼티 값 또는 참조 : DI에 사용할 프로퍼티 이름과 값 또는 참조하는 빈의 이름
	- 생성자 파라미터 값 또는 참조 : DI에 사용할 생성자 파라미터 이름과 값 또는 참조할 빈의 이름
	- 지연로딩 여부, 우선 빈 여부, 자동와이어링 여부, 부모 빈 정보, 빈팩토리 이름 등

결국 스프링 애플리케이션이란 POJO 클래스와 설정 메타정보를 이용해 IoC컨테이너가 만들어주는 오브젝트 조합이다.


#### 1.1.2 IoC컨테이너의 종류와 사용방법
이미 스프링에는 다양한 용도로 쓸 수 있는 십여 개의 ApplicationContext 구현 클래스가 존재한다. 직접 코드를 통해 ApplicationContext 오브젝트를 생성하는 경우는 거의 없다. 스프링에서 제공하는 ApplicationContext 구현 클래스 종류에 대해 살펴보자.

##### StaticApplicationContext
BeanDefinition 오브젝트를 직접 만들고, 코드를 통해 IoC 컨테이너에 등록하는 방법을 사용해봤다. 이 때 사용하는 컨테이너는 StaticApplicationContext다. StaticApplicationContext는 코드를 통해 빈 메타정보를 등록하기 위해 사용한다.
스프링의 기능에 대한 학습테스트를 제외하면 실제로 사용하지 않는다. 스태틱 애플리케이션 컨텍스트는 실전에서는 사용하면 안 된다. ( 이유에 대해 찾아봤지만 안나와서 코드를 봐보니 기본생성자가 Null로 되어있어서 그런가?? 추후 더 찾아볼 예정 )

##### GenericApplicationContext
GenericApplicationContext는 가장 일반적인 애플리케이션 구현 클래스이다. 실전에서 사용될 수 있는 모든 기능을 갖추고 있으며 컨테이너의 주요 기능을 DI를 통해 확장할 수 있도록 설계되었다. StaticApplicationContext 와는 달리 XML 파일과 같은 외부의 리소스에 있는 빈 설정 메타정보를 리더를 통해 읽어들여서 메타정보로 전환해서 사용한다. 스프링은 XML 말고도 프로퍼티 파일에서 빈 설정 메타정보를 가져오는 PropertiesBeanDefinitionReader도 제공한다.
JUnit 테스트 내에서 사용할 수 있는 애플리케이션 컨텍스트를 자동으로 만들어 주는데 이 컨텍스트가 바로 GenericApplicationContext다.

##### GenericXmlApplicationContext
GenericXmlApplicationContext 는 XmlBeanDefinitionReader를 내장하고 있기 떄문에 따로 만들지 않고 XML파일을 읽어서 refresh를 통해 초기화하는 것 까지 한 줄로 끝낼 수 있다.

##### WebApplicationContext
웹 환경에서 main() 메서드 대신 서블릿 컨테이너가 브라우저로의 오는 HTTP 요청을 받아서 해당 요청에 매핑되어 있는 서블릿을 실행해주는 방식으로 동작한다. 서블릿이 일종의 main() 메서드와 같은 역할을 하는 셈이다.
서블릿 컨테이너는 브라우저와 같은 클라이언트로부터 들어오는 요청을 받아서 서블릿을 동작시켜주는 일을 맡는다. 다행히도 스프링은 웹 환경에서 애플리케이션 컨텍스트를 생성하고 설정 메타 정보로 초기화해주고, 클라이언트로부터 들어오는 요청마다 적절한 빈을 찾아서 이를 실행해주는 기능을 가진 DispatcherServlet이라는 이름의 서블릿을 제공한다. 일단 스프링 IoC 컨테이너는 WebApplicationContext 인터페이스를 구현한 것임을 기억하자.

#### 1.1.3 IoC 컨테이너 계층구조
IoC 컨테이너는 애플리케이션마다 하나씩이면 충분하다. 빈의 개수가 많아져서 설정파일이 커지는게 문제라면 쪼개서 만들고 하나의 애플리케이션 컨텍스트가 어려 개의 설정파일을 사용하게 하면 그만이다.
하지만 한 개 이상의 IoC 컨테이너를 만들어두고 사용해야 할 때가 있는데 바로 트리 모양의 계층 구조이다.

##### 부모 컨텍스트를 이용한 계층구조 효과
계층구조 안에 모든 컨텍스트는 각자 독립적인 설정정보를 가지고 빈 오브젝트를 만들고 관리한다. 하지만 DI를 위해 빈을 찾을 때는 자신의 빈부터 부모 컨텍스트의 빈까지 모두 검색한다. 다만 하위 컨텍스트에서는 빈을 검색하지 않는다. 그런 의미에서 같은 레벨에 있는 형제 컨텍스트의 빈도 찾을 수 없다. 때문에 자신이 만든 스프링 애플리케이션이 어떻게 컨텍스트가 만들어지고 어느 것이 루트 컨텍스트이고, 어느 것이 그 자식 컨텍스트인지는 분명하게 알아야 한다.

#### 1.1.4 웹 애플리케이션의 IoC 컨테이너 구성
애플리케이션에서 IoC 컨테이너를 사용하는 방법은 크게 세 가지로 구분된다. 두 가지는 웹 모듈 안에 컨테이너를 두는 것이고, 하나는 엔터프라이즈 애플리케이션 레벨에 두는 방법이다.

많은 웹 요청을 한 번에 받을 수 있는 대표 서블릿을 등록해두고, 공통적인 선행 작업을 수행하게 한 후에 각 요청의 기능을 담당하는 핸들러라고 불리는 클래스를 호출하는 방식으로 개발한다.

##### 웹 애플리케이션의 컨텍스트 계층구조
웹 애플리케이션 컨텍스트에 등록되는 컨테이너는 루트 웹 애플리케이션 컨텍스트라고 불린다. 일반적으로 전체 계층구조 내에서 가장 최상단에 위치한 루트 컨텍스트가 되기 떄문이다.
그런데 여러 개의 자식 컨텍스트를 두고 공통적인 빈을 부모 컨텍스트로 뽑아내서 공유하려는게 아니라면 왜 이렇게 계층구조로 만들까?? 이유는 전체 애플리케이션에서 웹 기술에 의존적인 부분과 그렇지 않은 부분을 구분하기 위해서다.
데이터 엑세스 계층, 서비스 계층은 스프링 기술을 사용하고 스프링 빈으로 만들지만 웹을 담당하는 프레젠테이션 계층은 스프링 외의 기술을 사용하는 경우도 종종 있기 때문이다.

스프링은 웹 애플리케이션마다 하나씩 존재하는 서블릿 컨테이너를 통해 루트 애플리케이션 컨텍스트에 접근할 수 있는 방법을 제공한다.

- WebApplicationContextUtils.getWebApplicationContext(ServletContext sc) : DispatcherServlet이나 WebApplicationContext에 접근할 수 있는 static 메서드를 제공한다.

ServletContext는 웹 애플리케이션마다 하나씩 만들어지는 것으로, 서블릿의 런타임 환경정보를 담고있다.

##### 웹 애플리케이션 컨텍스트 구성 방법
1. 컨텍스트 계층구조 만들기
2. 컨텍스트를 하나만 사용하기

- 서블릿 컨텍스트와 루트 애플리케이션 컨텍스트 계층구조
	- 가장 많이 사용되는 기본적인 구성방법이다. 스프링 웹 기술을 사용하는 경우 웹 관련 빈들은 서블릿의 컨텍스트에 두고 나머지는 루트 애플리케이션 컨텍스트에 등록한다.

- 루트 애플리케이션 컨텍스트 단일구조
	- 스프링 웹 기술을 사용하지 않고 서드파티 웹 프레임워크나 서비스 엔진만을 사용해서 프레젠테이션 계층을 만든다면 스프링 서블릿을 둘 이유가 없다.

- 서블릿 컨텍스트 단일 구조
	- 스프링 웹 기술을 사용하면서 스프링 외의 프레임워크나 서비스 엔진에서 스프링 빈을 이용할 생각이 아니라면 루트 애플리케이션 컨텍스트를 생략할 수도 있다.


##### 루트 애플리케이션 컨텍스트 등록
웹 애플리케이션 레벨에 만들어지는 루트 웹 애플리케이션 컨텍스트를 등록하는 가장 간단한 방법은 서블릿의 이벤트 리스너를 이용하는 것이다. 웹 애플리케이션 전체에 적용 가능한 DB 연결 기능이나 로깅 같은 서비스를 만드는 데 유용하게 쓰인다. 스프링은 이러한 기능을 가진 리스너인 ContextLoaderListener를 제공한다.

```JAVA
/** 
ContextLoaderListener 등록 방법 : web.xml에 리스너 선언
기능 : 웹 애플리케이션이 시작할 때 자동으로 루트 애플리케이션 컨텍스트 생성 후 초기화

Default
애플리케이션 컨텍스트 클래스 : XmlWebApplicationContext
XML 설정파일 위치 : /WEB-INF/applicationContext.xml
*/

<listener>
	<listener-class>org.springframework.web.context.ContextLoaderListener</listener-class>
</listener>
```

- contextConfigLocation : 디폴트 XML 설정파일 위치를 바꿀 수 있다.
- contextClass : 디폴트 애플리케이션컨텍스트 클래스를 변경할 수 있다.

##### 서블릿 애플리케이션 컨텍스트 등록
스프링의 웹 기능을 지원하는 프론트 컨트롤러 서블릿은 DispatcherServlet이다. 이름에서 알 수 있듯이 web.xml에 등록해서 사용할 수 있는 평범한 서블릿이다. 각 DispatcherServlet은 서블릿이 초기화 될 때 자신만의 컨텍스트를 생성하고 초기화한다.

### 1.2 IoC/DI를 위한 빈 설정 메타정보 작성
IoC 컨테이너의 가장 기본적인 역할은 코드를 대신해서 애플리케이션을 구성하는 오브젝트를 생성하고 관리하는 것이다. POJO로 만들어진 애플리케이션 클래스와 서비스 오브젝트들이 그 대상이다.
빈을 만들기 위한 설정 메타정보는 파일이나 어노테이션 같은 리소스로부터 전용 리더를 통해 얽혀서 BeanDefinition 타입의 오브젝트로 변환된다. BeanDefinition에 어떠한 방식으로든 빈 생성 정보만 담겨있다면 IoC 컨테이너가 빈을 읽어서 처리할 수 있다.

#### 1.2.1 빈 설정 메타정보
BeanDefinition은 여러 개의 빈을 만드는 데 재사용될 수 있다. 설정 메타정보가 같지만 이름이 다른 여러 개의 빈 오브젝트를 만들 수 있기 때문이다.
따라서 BeanDefinition 에는 빈의 이름이나 아이디를 나타내는 정보를 포함하지 않는다. 대신 IoC 컨테이너에 이 BeanDefinition 정보가 등록될 때 이름을 부여해줄 수 있다.

#### 1.2.2 빈 등록 방법
빈 등록 방법은 메타정보를 작성해서 컨테이너에게 건네주면 된다. 보통 XML문서, 프로퍼티 파일, 소스코드 어노테이션과 같은 외부 리소스로 빈 메타정보를 작성하고 이를 적절한 리더나 변환기를 통해 애플리케이션 컨텍스트가 사용할 수 있는 정보로 변환해주는 방법을 사용한다.

스프링에서 자주사용되는 빈의 등록방법 5가지

- XML :<Bean>태그
- XML : 네임스페이스와 전용 태그
- 자동인식을 이용한 빈 등록 : 스테레오타입 어노테이션과 빈 스캐너
- XML을 이용한 빈 스캐너 등록
- 빈 스캐너를 내장한 애플리케이션 컨텍스트 사용


##### 자바 코드에 의한 빈 등록 : @Configuration 클래스의 @Bean 메서드
자바코드를 이용한 빈 등록에 사용되는 클래스는 그저 평범한 자바 코드처럼 동작하지 않는다는 사실을 알아야 한다. @Bean이 붙은 메서드는 new를 통한 여러번 생성을 시켜도 싱글톤이 디폴트 값이기 때문에 최초 한번만 빈으로 생성된다.  DI를 통해 다른 여러 빈에 참조되든, getBean() 메서드에 의해 가져오든 상관없이 한 개의 오브젝트만 생성이 되고 더 이상 새로운 오브젝트가 만들어지지 않도록 특별한 방법으로 @Bean 메서드를 조작해둔다.